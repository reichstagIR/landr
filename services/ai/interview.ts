import { JobInfos } from "@/drizzle/schema";
// Hume
import { fetchChatMessages } from "../hume/lib/api";
// AI
import { generateText } from "ai";
// Model
import { google } from "./models/google";

type TGenerateAiInterviewFeedback = {
    humeChatId: string;
    jobInfo: Pick<
        typeof JobInfos.$inferSelect,
        "title" | "description" | "experienceLevel"
    >;
    userName: string;
};

export async function generateAiInterviewFeedback({
    humeChatId,
    jobInfo,
    userName,
}: TGenerateAiInterviewFeedback) {
    const messages = await fetchChatMessages(humeChatId);

    const formattedMessages = messages
        .map((message) => {
            if (
                message.type !== "USER_MESSAGE" &&
                message.type !== "AGENT_MESSAGE"
            ) {
                return null;
            }
            if (message.messageText == null) return null;

            return {
                speaker:
                    message.type === "USER_MESSAGE"
                        ? "interviewee"
                        : "interviewer",
                text: message.messageText,
                emotionFeatures:
                    message.role === "USER"
                        ? message.emotionFeatures
                        : undefined,
            };
        })
        .filter((f) => f != null);

    const { text } = await generateText({
        model: google("gemini-2.5-flash"),
        prompt: JSON.stringify(formattedMessages),
        maxSteps: 10,
        experimental_continueSteps: true,
        system: `شما یک مربی و ارزیاب متخصص مصاحبه هستید. نقش شما تجزیه و تحلیل یک متن مصاحبه شغلی آزمایشی و ارائه بازخورد واضح، دقیق و ساختارمند در مورد عملکرد مصاحبه‌شونده بر اساس الزامات شغلی است. خروجی شما باید در قالب markdown باشد.


--

متن اضافی:

نام مصاحبه‌شونده: ${userName}

عنوان شغلی: ${jobInfo.title}

شرح شغل: ${jobInfo.description}

سطح تجربه شغلی: ${jobInfo.experienceLevel}

---

قالب JSON متن:

گوینده: "مصاحبه‌شونده" یا "مصاحبه‌کننده"
متن: "متن گفتاری واقعی پیام"
ویژگی‌های احساسی: "یک شیء از ویژگی‌های احساسی که در آن کلید، احساس و مقدار، شدت (0-1) است. این فقط برای پیام‌های مصاحبه‌شونده ارائه می‌شود."

--

وظیفه شما:

متن کامل را مرور کنید و عملکرد مصاحبه‌شونده را در رابطه با نقش ارزیابی کنید. بازخورد دقیق و ساختاریافته‌ای را در دسته‌بندی‌های اصلی زیر ارائه دهید (زیرمقوله‌ها را در پاسخ خود تکرار نکنید و در عوض فقط از آنها به عنوان مرجعی برای آنچه باید جستجو کنید و در پاسخ خود بگنجانید استفاده کنید):

---

دسته‌بندی‌های بازخورد:

1. **وضوح ارتباط**
- آیا مصاحبه‌شونده رسا و قابل فهم بود؟
- آیا از زبان ساختاریافته و مناسب برای این شغل و سطح تجربه استفاده کردند؟

2. **اعتماد به نفس و حالت عاطفی**
- بر اساس نشانه‌های عاطفی ارائه شده و محتوای گفتار، مصاحبه‌شونده چقدر با اعتماد به نفس به نظر می‌رسید؟
- هرگونه لحظه عصبی یا مرددی را که ممکن است بر برداشت او تأثیر گذاشته باشد، برجسته کنید.

3. **کیفیت پاسخ**
- آیا مصاحبه‌شونده با پاسخ‌های مرتبط و مستدل و مطابق با الزامات شغلی پاسخ داد؟
- آیا پاسخ‌ها به طور مناسب برای سطح تجربه او (مثلاً عمق جزئیات، استفاده از مثال‌ها) تنظیم شده بودند؟

۴. **سرعت و زمان‌بندی**
- تأخیرهای بین سوالات مصاحبه‌کننده و پاسخ‌های مصاحبه‌شونده را تجزیه و تحلیل کنید.

- مکث‌های طولانی یا غیرطبیعی را که ممکن است نشان‌دهنده عدم اطمینان یا عدم آمادگی باشد، مشخص کنید.


۵. **تعامل و تعامل**
- آیا مصاحبه‌شونده کنجکاوی نشان داد یا سوالات متفکرانه‌ای پرسید؟

- آیا آنها به گونه‌ای در مکالمه مشارکت کردند که نشان‌دهنده علاقه به نقش و شرکت باشد؟


۶. **تناسب و هم‌ترازی نقش**
- بر اساس شرح شغل و پاسخ‌های کاندیدا، مصاحبه‌شونده چقدر با انتظارات برای این نقش و سطح مطابقت دارد؟

- هرگونه شکاف در مهارت‌های فنی یا نرم را شناسایی کنید.


۷. **نقاط قوت کلی و زمینه‌های بهبود**
- نقاط قوت برتر را خلاصه کنید.

- مهم‌ترین زمینه‌های بهبود را مشخص کنید.

- یک ارزیابی کلی از عملکرد ارائه دهید.


--
یادداشت‌های تکمیلی:

- در صورت لزوم، به لحظات خاص از متن مصاحبه، از جمله نقل قول‌ها و مهرهای زمانی، اشاره کنید. ویژگی‌های عاطفی خاص را در پاسخ خود ذکر نکنید.
- تحلیل و بازخورد خود را با شرح شغل خاص و سطح تجربه ارائه شده تطبیق دهید.
- واضح، سازنده و عملی باشید. هدف کمک به رشد مصاحبه‌شونده است.
- عنوان h1 یا اطلاعاتی در مورد شرح شغل را در پاسخ خود ذکر نکنید، فقط بازخورد را ذکر کنید.
- در بازخورد خود از مصاحبه‌شونده با عنوان "شما" یاد کنید. این بازخورد باید طوری نوشته شود که انگار مستقیماً با مصاحبه‌شونده صحبت می‌کنید.
- در عنوان هر دسته، یک امتیاز عددی (از 10) و همچنین یک امتیاز کلی در همان ابتدای پاسخ قرار دهید.
- به محض اینکه بازخورد کامل را ارائه دادید، تولید خروجی را متوقف کنید.`,
    });

    return text;
}
